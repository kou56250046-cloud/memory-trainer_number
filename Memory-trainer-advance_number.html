<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ§  æ•°å­—è¨˜æ†¶ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
<style>
  body { background: #0f172a; color: #e5e7eb; font-family: system-ui;
         max-width: 800px; margin: 30px auto; padding: 0 16px; text-align: center; }
  h1 { font-size: 26px; margin-bottom: 10px; }
  .hidden { display: none; }
  .number-box { font-size: 28px; letter-spacing: 4px; padding: 20px;
                background: #1e293b; border-radius: 12px; margin: 20px 0; }
  input[type="number"], input[type="text"] {
    padding: 8px; font-size: 16px; border-radius: 8px; border: none;
    text-align: center; margin: 4px;
  }
  button {
    background: #22c55e; color: #000; border: none; padding: 10px 16px;
    font-size: 16px; border-radius: 8px; cursor: pointer; margin: 6px;
  }
  button.danger { background: #ef4444; color: #fff; }
  button.ghost { background: #0b1220; color: #e5e7eb; border: 1px solid #223; }
  .result-box { margin-top: 20px; padding: 10px; background: #1e293b; border-radius: 8px; }
  .chip { background:#0b1220;border:1px solid #334155;padding:6px 10px;
          border-radius:999px;margin:4px;display:inline-block; }
  canvas { margin-top: 20px; background:#0b1220;border:1px solid #223;border-radius:12px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>ğŸ§  æ•°å­—è¨˜æ†¶ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>

<!-- è¨­å®š -->
<div>
  <label>æ¡æ•°ï¼š</label>
  <input id="digitCount" type="number" min="1" max="100" value="20">
  <label>è¡¨ç¤ºç§’æ•°ï¼š</label>
  <input id="seconds" type="number" min="1" max="60" value="30">
</div>
<button id="start">â–¶ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</button>

<!-- è¡¨ç¤ºãƒ•ã‚§ãƒ¼ã‚º -->
<div id="showPhase" class="hidden">
  <div class="number-box" id="numberDisplay"></div>
  <div id="countdown"></div>
</div>

<!-- å›ç­”ãƒ•ã‚§ãƒ¼ã‚º -->
<div id="answerPhase" class="hidden">
  <p>è¦šãˆãŸæ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ğŸ‘‡</p>
  <input type="text" id="answerInput" placeholder="ã“ã“ã«å…¥åŠ›">
  <button id="check">æ¡ç‚¹</button>
</div>

<!-- çµæœãƒ•ã‚§ãƒ¼ã‚º -->
<div id="resultPhase" class="hidden">
  <div class="result-box">
    <p><b>æ­£è§£ï¼š</b><span id="correct"></span></p>
    <p><b>ã‚ãªãŸã®å…¥åŠ›ï¼š</b><span id="yourAnswer"></span></p>
    <p><b>æ­£ç­”ç‡ï¼š</b><span id="accuracy"></span>%</p>
  </div>
  <button id="restart" class="ghost">ã‚‚ã†ä¸€åº¦</button>
</div>

<!-- ç§°å·ãƒ»ã‚°ãƒ©ãƒ• -->
<hr>
<h2>ğŸ… ç§°å·</h2>
<div id="titleDisplay"></div>
<p>é€£ç¶šè¨˜éŒ²ï¼š<span id="streakDisplay">0</span>æ—¥ï½œå¹³å‡æ­£ç­”ç‡ï¼š<span id="avgDisplay">0</span>%</p>

<h2>ğŸ“Š æ­£ç­”ç‡ã®æ¨ç§»</h2>
<canvas id="chart" width="600" height="200"></canvas>

<!-- å±¥æ­´æ“ä½œ -->
<div style="margin-top:20px;">
  <button id="exportCsv" class="ghost">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button id="clearHist" class="danger">ğŸ§¹ å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
const numberDisplay = document.getElementById("numberDisplay");
const showPhase = document.getElementById("showPhase");
const answerPhase = document.getElementById("answerPhase");
const resultPhase = document.getElementById("resultPhase");
const answerInput = document.getElementById("answerInput");
const correctEl = document.getElementById("correct");
const yourAnswerEl = document.getElementById("yourAnswer");
const accuracyEl = document.getElementById("accuracy");
const countdownEl = document.getElementById("countdown");

let correctNumber = "";
let timer = null;
let secLeft = 0;
let history = JSON.parse(localStorage.getItem("digit_history") || "[]");

function generateDigits(n) {
  let s = "";
  for (let i = 0; i < n; i++) s += Math.floor(Math.random() * 10);
  return s;
}
function setPhase(phase) {
  showPhase.classList.add("hidden");
  answerPhase.classList.add("hidden");
  resultPhase.classList.add("hidden");
  if (phase) document.getElementById(phase).classList.remove("hidden");
}
function startTraining() {
  const digitCount = Math.max(1, Math.min(100, Number(document.getElementById("digitCount").value)));
  const seconds = Math.max(1, Math.min(60, Number(document.getElementById("seconds").value)));

  correctNumber = generateDigits(digitCount);
  numberDisplay.textContent = correctNumber;
  secLeft = seconds;
  countdownEl.textContent = `ã‚ã¨ ${secLeft} ç§’`;

  setPhase("showPhase");
  timer = setInterval(() => {
    secLeft--;
    countdownEl.textContent = `ã‚ã¨ ${secLeft} ç§’`;
    if (secLeft <= 0) {
      clearInterval(timer);
      setPhase("answerPhase");
      answerInput.value = "";
      answerInput.focus();
    }
  }, 1000);
}
function checkAnswer() {
  const ans = answerInput.value.trim();
  let hit = 0;
  for (let i = 0; i < correctNumber.length; i++) {
    if (ans[i] === correctNumber[i]) hit++;
  }
  const acc = Math.round((hit / correctNumber.length) * 100);
  correctEl.textContent = correctNumber;
  yourAnswerEl.textContent = ans || "ï¼ˆæœªå…¥åŠ›ï¼‰";
  accuracyEl.textContent = acc;
  setPhase("resultPhase");

  history.push({ timestamp: new Date().toLocaleString(), accuracy: acc });
  localStorage.setItem("digit_history", JSON.stringify(history));
  updateTitles();
  drawChart();
}

// ====== ç§°å·æ©Ÿèƒ½ ======
function calcStreak(){
  if (!history.length) return 0;
  const days = [...new Set(history.map(r=>new Date(r.timestamp).toLocaleDateString()))]
    .sort((a,b)=>new Date(b)-new Date(a));
  const today = new Date().toLocaleDateString();
  let streak = 0, current = new Date(today);
  for(const d of days){
    const dd=new Date(d);
    if(dd.toLocaleDateString()===current.toLocaleDateString()){
      streak++; current.setDate(current.getDate()-1);
    } else break;
  }
  return streak;
}
function calcAverageAccuracy(){
  if (!history.length) return 0;
  return Math.round(history.reduce((a,b)=>a+b.accuracy,0)/history.length);
}
function updateTitles(){
  const streak = calcStreak();
  const avg = calcAverageAccuracy();
  const titles = [];
  if(streak>=7)  titles.push("ğŸŒ± é›†ä¸­ã®èŠ½");
  if(streak>=30) titles.push("âš”ï¸ ç¶™ç¶šã®æˆ¦å£«");
  if(avg>=90)    titles.push("ğŸ§  è¨˜æ†¶ã®é”äºº");
  else if(avg>=80) titles.push("ğŸ“˜ å®‰å®šã®è¦šè€…");
  document.getElementById("titleDisplay").innerHTML = titles.length ? 
    titles.map(t=>`<span class="chip">${t}</span>`).join("") :
    `<span class="muted">ã¾ã ç§°å·ã¯ã‚ã‚Šã¾ã›ã‚“</span>`;
  document.getElementById("streakDisplay").textContent = streak;
  document.getElementById("avgDisplay").textContent = avg;
}

// ====== ã‚°ãƒ©ãƒ•æ©Ÿèƒ½ ======
let chartInstance = null;
function drawChart(){
  const labels = history.map(h=>h.timestamp);
  const values = history.map(h=>h.accuracy);
  const ctx = document.getElementById('chart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[{label:"æ­£ç­”ç‡",data:values,borderColor:'#22c55e',tension:0.2}] },
    options:{ responsive:true, scales:{ y:{min:0,max:100,ticks:{callback:v=>v+"%"} } } }
  });
}

// ====== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ======
function exportToCSV() {
  if (!history.length) {
    alert("å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  const header = ["No","æ—¥æ™‚","æ­£ç­”ç‡(%)"];
  const rows = history.map((h,i)=>[i+1,h.timestamp,h.accuracy]);
  const csv = [header, ...rows].map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "digit_memory_history.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ====== å±¥æ­´ãƒªã‚»ãƒƒãƒˆ ======
function clearHistory(){
  if(!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  history = [];
  localStorage.removeItem("digit_history");
  updateTitles();
  drawChart();
  alert("å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
}

// ====== ã‚¤ãƒ™ãƒ³ãƒˆ ======
document.getElementById("start").addEventListener("click", startTraining);
document.getElementById("check").addEventListener("click", checkAnswer);
document.getElementById("restart").addEventListener("click", () => setPhase(null));
document.getElementById("exportCsv").addEventListener("click", exportToCSV);
document.getElementById("clearHist").addEventListener("click", clearHistory);

// åˆæœŸåŒ–
updateTitles();
drawChart();
</script>

</body>
</html>
