<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>ğŸ§  æ•°å­—è¨˜æ†¶ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
<style>
  body { background:#0f172a; color:#e5e7eb; font-family: system-ui; margin:0; padding:20px;}
  h1 { margin-bottom:10px; }

  .number-box {
    font-size: 28px;
    letter-spacing: 4px;
    padding: 20px;
    background: #1e293b;
    border-radius: 12px;
    margin: 20px 0 10px;
    word-wrap: break-word;
    white-space: normal;
    overflow-wrap: break-word;
    text-align: center;
  }

  .progress-container {
    width: 100%;
    height: 10px;
    background: #1e293b;
    border-radius: 999px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #84cc16);
    width: 100%;
    transition: width 0.2s linear;
  }

  textarea { width:100%; height:80px; font-size:18px; padding:10px; background:#1e293b; color:#fff; border:none; border-radius:8px;}
  button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
  .primary { background:#22c55e; color:#052e16; }
  .ghost { background:#1e293b; color:#e5e7eb; border:1px solid #334155; }
  .danger { background:#ef4444; color:white; }
  .pill { display:inline-block; background:#1e293b; padding:6px 12px; margin:4px; border-radius:999px; }
  #chart, #avgChart { background:#1e293b; border-radius:12px; margin-top:20px; }
  #countdownText { text-align:center; font-size:16px; color:#94a3b8; margin-bottom:5px; }

  table { width:100%; margin-top:16px; border-collapse:collapse; }
  th, td { border-bottom:1px solid #334155; padding:8px; text-align:center; font-size:14px; }
  th { color:#93c5fd; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>ğŸ§  æ•°å­—è¨˜æ†¶ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>

<div>
  <label>æ¡æ•°ï¼š</label>
  <input id="digitCount" type="number" min="1" max="100" value="20">
  <label>è¡¨ç¤ºç§’æ•°ï¼š</label>
  <input id="seconds" type="number" min="3" max="60" value="15">
  <button class="primary" id="startBtn">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ â–¶</button>
</div>

<div class="number-box" id="numberDisplay"></div>
<div id="countdownText"></div>
<div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

<!-- å›ç­”å…¥åŠ› -->
<div id="inputArea" hidden>
  <h3>æ€ã„å‡ºã—ã¦å…¥åŠ›</h3>
  <textarea id="answer"></textarea>
  <br>
  <button class="primary" id="checkBtn">æ¡ç‚¹</button>
  <button class="ghost" id="retryBtn">âŸ² ã‚„ã‚Šç›´ã—</button>
</div>

<!-- çµæœè¡¨ç¤º -->
<div id="resultArea" hidden>
  <h3>çµæœ</h3>
  <div class="pill">æ­£ç­”ç‡ï¼š<span id="accuracyText">0</span>%</div>
  <div class="pill">ã‚¹ã‚³ã‚¢ï¼š<span id="scoreText">0</span></div>
  <div class="pill">æ¡æ•°ï¼š<span id="digitText">0</span></div>
  <div class="pill">æ™‚é–“ï¼š<span id="timeText">0</span>ç§’</div>
  <div class="pill">ä¸€è‡´æ•°ï¼š<span id="hitText">0</span></div>
  <br>
  <button class="primary" id="nextBtn">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ â–¶</button>
</div>

<h2>ğŸ… ç§°å·</h2>
<div id="titleDisplay" class="pill">ã¾ã ç§°å·ã¯ã‚ã‚Šã¾ã›ã‚“</div>

<!-- æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• -->
<h2>ğŸ“ˆ ã‚¹ã‚³ã‚¢å±¥æ­´</h2>
<canvas id="chart"></canvas>

<!-- å¹³å‡ã‚¹ã‚³ã‚¢æ£’ã‚°ãƒ©ãƒ• -->
<h2>ğŸ“Š å¹³å‡ã‚¹ã‚³ã‚¢</h2>
<div>
  <button class="ghost" id="dailyBtn">æ—¥åˆ¥</button>
  <button class="ghost" id="monthlyBtn">æœˆåˆ¥</button>
</div>
<canvas id="avgChart"></canvas>

<!-- ã‚¹ã‚³ã‚¢è¡¨ -->
<h2>ğŸ§® ã‚¹ã‚³ã‚¢ä¸€è¦§</h2>
<table>
  <thead>
    <tr>
      <th>#</th><th>æ—¥æ™‚</th><th>æ­£ç­”ç‡</th><th>æ¡æ•°</th><th>æ™‚é–“</th><th>ã‚¹ã‚³ã‚¢</th>
    </tr>
  </thead>
  <tbody id="scoreTable"></tbody>
</table>

<div style="margin-top:10px;">
  <button class="ghost" id="exportCsv">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button class="danger" id="clearHist">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
const display = document.getElementById("numberDisplay");
const inputArea = document.getElementById("inputArea");
const resultArea = document.getElementById("resultArea");
const answerEl = document.getElementById("answer");
const accuracyEl = document.getElementById("accuracyText");
const scoreEl = document.getElementById("scoreText");
const timeEl = document.getElementById("timeText");
const hitEl = document.getElementById("hitText");
const digitEl = document.getElementById("digitText");
const countdownText = document.getElementById("countdownText");
const progressBar = document.getElementById("progressBar");

let correctNumber = "";
let timer = null;
let countdownTimer = null;
let history = JSON.parse(localStorage.getItem("digit_history") || "[]");
let chartInstance = null;
let avgChartInstance = null;
let avgMode = "day"; // æ—¥ or æœˆ

// ===== æ•°å­—åˆ—ç”Ÿæˆ =====
function generateDigits(len) {
  return Array.from({length: len}, () => Math.floor(Math.random()*10)).join('');
}

// ===== ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ =====
function adjustFontSize() {
  const len = correctNumber.length;
  display.style.fontSize = len <= 20 ? "28px" : len <= 50 ? "22px" : "18px";
}

// ===== ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ =====
document.getElementById("startBtn").addEventListener("click", () => {
  const len = Number(document.getElementById("digitCount").value);
  const sec = Number(document.getElementById("seconds").value);
  correctNumber = generateDigits(len);
  adjustFontSize();
  display.textContent = correctNumber;
  inputArea.hidden = true;
  resultArea.hidden = true;

  let remaining = sec;
  countdownText.textContent = `æ®‹ã‚Š ${remaining} ç§’`;
  progressBar.style.width = "100%";

  clearInterval(countdownTimer);
  countdownTimer = setInterval(() => {
    remaining--;
    countdownText.textContent = `æ®‹ã‚Š ${remaining} ç§’`;
    progressBar.style.width = (remaining / sec) * 100 + "%";
    if (remaining <= 0) clearInterval(countdownTimer);
  }, 1000);

  clearTimeout(timer);
  timer = setTimeout(() => {
    display.textContent = "ğŸ™ˆ";
    countdownText.textContent = "";
    progressBar.style.width = "0%";
    inputArea.hidden = false;
    answerEl.value = "";
    answerEl.focus();
  }, sec * 1000);
});

// ===== æ¡ç‚¹ =====
document.getElementById("checkBtn").addEventListener("click", () => {
  clearInterval(countdownTimer);
  const ans = answerEl.value.trim();
  const len = correctNumber.length;
  const sec = Number(document.getElementById("seconds").value);
  let hit = 0;
  for (let i = 0; i < len; i++) if (ans[i] === correctNumber[i]) hit++;

  const acc = Math.round((hit / len) * 100);
  const score = Math.round(acc * (len / sec));

  accuracyEl.textContent = acc;
  scoreEl.textContent = score;
  timeEl.textContent = sec;
  hitEl.textContent = hit;
  digitEl.textContent = len;

  history.push({
    timestamp: new Date().toLocaleString(),
    accuracy: acc,
    time: sec,
    digits: len,
    score: score
  });
  localStorage.setItem("digit_history", JSON.stringify(history));

  resultArea.hidden = false;
  inputArea.hidden = true;
  updateTitles();
  drawScoreChart();
  drawAvgChart();
  renderTable();
});

// ===== ç§°å·æ›´æ–° =====
function updateTitles(){
  if (history.length === 0) return;
  const avgScore = Math.round(history.reduce((a,b)=>a+b.score,0)/history.length);
  const titles = [];
  if (avgScore >= 800) titles.push("ğŸš€ ç¥é€Ÿã®è¨˜æ†¶ç‹");
  else if (avgScore >= 600) titles.push("âš¡ é«˜é€Ÿè¨˜æ†¶ãƒã‚¹ã‚¿ãƒ¼");
  else if (avgScore >= 400) titles.push("ğŸ“˜ å®‰å®šè¨˜æ†¶ã®é”äºº");

  document.getElementById("titleDisplay").innerHTML = titles.length
    ? titles.map(t=>`<span class="pill">${t}</span>`).join("")
    : `<span class="pill">ã¾ã ç§°å·ã¯ã‚ã‚Šã¾ã›ã‚“</span>`;
}

// ===== æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼ˆå±¥æ­´ï¼‰ =====
function drawScoreChart(){
  const labels = history.map((h,i)=>`#${i+1}`);
  const scores = history.map(h=>h.score);
  const ctx = document.getElementById("chart").getContext("2d");
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:"line",
    data:{ labels, datasets:[{ label:"ã‚¹ã‚³ã‚¢", data:scores, borderColor:"#22c55e", tension:0.2 }] },
    options:{ responsive:true, scales:{ y:{ beginAtZero:true, suggestedMax:300 } } }
  });
}

// ===== æ—¥/æœˆé›†è¨ˆ =====
function aggregateAvg(){
  const daily = {}, monthly = {};
  history.forEach(h=>{
    const d = new Date(h.timestamp);
    const dayKey = d.toLocaleDateString();
    const monthKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    (daily[dayKey] ||= []).push(h.score);
    (monthly[monthKey] ||= []).push(h.score);
  });
  const dailyAvg = Object.entries(daily).map(([k,v])=>({label:k,avg:Math.round(v.reduce((a,b)=>a+b,0)/v.length)}));
  const monthlyAvg = Object.entries(monthly).map(([k,v])=>({label:k,avg:Math.round(v.reduce((a,b)=>a+b,0)/v.length)}));
  return { dailyAvg, monthlyAvg };
}

// ===== å¹³å‡ã‚¹ã‚³ã‚¢æ£’ã‚°ãƒ©ãƒ• =====
function drawAvgChart(){
  const { dailyAvg, monthlyAvg } = aggregateAvg();
  const data = avgMode === "day" ? dailyAvg : monthlyAvg;
  const labels = data.map(d=>d.label);
  const values = data.map(d=>d.avg);
  const ctx = document.getElementById("avgChart").getContext("2d");
  if(avgChartInstance) avgChartInstance.destroy();
  avgChartInstance = new Chart(ctx,{
    type:"bar",
    data:{ labels, datasets:[{ label:`å¹³å‡ã‚¹ã‚³ã‚¢ï¼ˆ${avgMode==="day"?"æ—¥åˆ¥":"æœˆåˆ¥"}ï¼‰`, data:values, backgroundColor:"#3b82f6" }] },
    options:{ responsive:true, scales:{ y:{ beginAtZero:true, suggestedMax:300 } } }
  });
}
document.getElementById("dailyBtn").addEventListener("click",()=>{avgMode="day";drawAvgChart();});
document.getElementById("monthlyBtn").addEventListener("click",()=>{avgMode="month";drawAvgChart();});

// ===== ã‚¹ã‚³ã‚¢è¡¨ =====
function renderTable(){
  const tbody = document.getElementById("scoreTable");
  tbody.innerHTML = "";
  history.forEach((h,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${h.timestamp}</td><td>${h.accuracy}%</td><td>${h.digits}</td><td>${h.time}</td><td>${h.score}</td>`;
    tbody.appendChild(tr);
  });
}

// ===== CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ =====
document.getElementById("exportCsv").addEventListener("click", () => {
  if (!history.length) { alert("å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  const header = ["No","æ—¥æ™‚","æ­£ç­”ç‡(%)","æ¡æ•°","è¡¨ç¤ºç§’æ•°","ã‚¹ã‚³ã‚¢"];
  const rows = history.map((h,i)=>[i+1,h.timestamp,h.accuracy,h.digits,h.time,h.score]);
  const csv = [header,...rows].map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "digit_memory_history.csv";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// ===== å±¥æ­´ãƒªã‚»ãƒƒãƒˆ =====
document.getElementById("clearHist").addEventListener("click", () => {
  if (!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  history = [];
  localStorage.removeItem("digit_history");
  updateTitles();
  drawScoreChart();
  drawAvgChart();
  renderTable();
  alert("å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
});

document.getElementById("retryBtn").addEventListener("click", () => {
  inputArea.hidden = false;
  resultArea.hidden = true;
  answerEl.value = "";
  answerEl.focus();
});

document.getElementById("nextBtn").addEventListener("click", () => {
  resultArea.hidden = true;
  display.textContent = "";
});

// åˆæœŸæç”»
drawScoreChart();
drawAvgChart();
updateTitles();
renderTable();
</script>
</body>
</html>
